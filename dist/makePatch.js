"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var chalk_1 = require("chalk");
var fs = require("fs");
var path = require("path");
var rimraf = require("rimraf");
var tmp = require("tmp");
var resolveRelativeFileDependencies_1 = require("./resolveRelativeFileDependencies");
var spawnSafe_1 = require("./spawnSafe");
var patchFs_1 = require("./patchFs");
var fsExtra = require("fs-extra");
function makePatch(packageName, appPath, packageManager) {
    var nodeModulesPath = path.join(appPath, "node_modules");
    var packagePath = path.join(nodeModulesPath, packageName);
    var packageJsonPath = path.join(packagePath, "package.json");
    if (!fs.existsSync(packageJsonPath)) {
        printNoPackageFoundError(packageName, packageJsonPath);
        process.exit(1);
    }
    var packageVersion = require(packageJsonPath).version;
    var tmpRepo = tmp.dirSync({ unsafeCleanup: true });
    var tmpRepoNodeModulesPath = path.join(tmpRepo.name, "node_modules");
    var tmpRepoPackageJsonPath = path.join(tmpRepo.name, "package.json");
    var tmpRepoPackagePath = path.join(tmpRepoNodeModulesPath, packageName);
    try {
        var patchesDir_1 = path.join(appPath, "patches");
        if (!fs.existsSync(patchesDir_1)) {
            fs.mkdirSync(patchesDir_1);
        }
        else {
            // remove exsiting patch for this package, if any
            patchFs_1.getPatchFiles(patchesDir_1).forEach(function (fileName) {
                if (fileName.startsWith(packageName + ":") ||
                    fileName.startsWith(packageName + "+")) {
                    console.info(chalk_1.green("☑"), "Removing existing", path.relative(process.cwd(), path.join(patchesDir_1, fileName)));
                    fs.unlinkSync(path.join(patchesDir_1, fileName));
                }
            });
        }
        console.info(chalk_1.green("☑"), "Creating temporary folder");
        var tmpExec_1 = function (command, args) {
            return spawnSafe_1.default(command, args, { cwd: tmpRepo.name });
        };
        // reinstall a clean version of the user's node_modules in our tmp location
        fsExtra.copySync(path.join(appPath, "package.json"), path.join(tmpRepo.name, "package.json"));
        // resolve relative file paths in package.json
        fs.writeFileSync(tmpRepoPackageJsonPath, JSON.stringify(resolveRelativeFileDependencies_1.resolveRelativeFileDependenciesInPackageJson(appPath, require(tmpRepoPackageJsonPath))));
        if (packageManager === "yarn") {
            fsExtra.copySync(path.join(appPath, "yarn.lock"), path.join(tmpRepo.name, "yarn.lock"));
            console.info(chalk_1.green("☑"), "Building clean node_modules with yarn");
            tmpExec_1("yarn");
        }
        else {
            var lockFileName = packageManager === "npm-shrinkwrap"
                ? "npm-shrinkwrap.json"
                : "package-lock.json";
            var lockFileContents = JSON.parse(fsExtra.readFileSync(path.join(appPath, lockFileName)).toString());
            var resolvedLockFileContents = resolveRelativeFileDependencies_1.resolveRelativeFileDependenciesInPackageLock(appPath, lockFileContents);
            fs.writeFileSync(path.join(tmpRepo.name, lockFileName), JSON.stringify(resolvedLockFileContents));
            console.info(chalk_1.green("☑"), "Building clean node_modules with npm");
            tmpExec_1("npm", ["i"]);
        }
        // commit the package
        console.info(chalk_1.green("☑"), "Diffing your files with clean files");
        fs.writeFileSync(path.join(tmpRepo.name, ".gitignore"), "!/node_modules\n\n");
        tmpExec_1("git", ["init"]);
        var stageFiles = function () {
            tmpExec_1("git", ["add", "-f", path.join("node_modules", packageName)]);
            tmpExec_1("git", [
                "rm",
                "--cached",
                path.join("node_modules", packageName, "package.json"),
            ]);
        };
        stageFiles();
        tmpExec_1("git", ["commit", "-m", "init"]);
        // replace package with user's version
        rimraf.sync(tmpRepoPackagePath);
        fsExtra.copySync(packagePath, tmpRepoPackagePath, { recursive: true });
        // add their files to the index
        stageFiles();
        // get diff of changes
        var patch = tmpExec_1("git", ["diff", "HEAD"]).stdout.toString();
        if (patch.trim() === "") {
            console.warn("\u2049\uFE0F  Not creating patch file for package '" + packageName + "'");
            console.warn("\u2049\uFE0F  There don't appear to be any changes.");
            process.exit(1);
        }
        else {
            var patchFileName = packageName + "+" + packageVersion + ".patch";
            var patchPath = path.join(patchesDir_1, patchFileName);
            if (!fs.existsSync(path.dirname(patchPath))) {
                // scoped package
                fs.mkdirSync(path.dirname(patchPath));
            }
            fs.writeFileSync(patchPath, patch);
            console.log(chalk_1.green("✔") + " Created file patches/" + patchFileName);
        }
    }
    catch (e) {
        console.error(e);
        throw e;
    }
    finally {
        tmpRepo.removeCallback();
    }
}
exports.default = makePatch;
function printNoPackageFoundError(packageName, packageJsonPath) {
    console.error("No such package " + packageName + "\n\n  File not found: " + packageJsonPath);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFrZVBhdGNoLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21ha2VQYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE2QjtBQUM3Qix1QkFBd0I7QUFDeEIsMkJBQTRCO0FBQzVCLCtCQUFnQztBQUNoQyx5QkFBMEI7QUFDMUIscUZBRzBDO0FBQzFDLHlDQUF1QztBQUN2QyxxQ0FBeUM7QUFDekMsa0NBQW1DO0FBR25DLG1CQUNFLFdBQW1CLEVBQ25CLE9BQWUsRUFDZixjQUE4QjtJQUU5QixJQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsQ0FBQTtJQUMxRCxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUMzRCxJQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxjQUFjLENBQUMsQ0FBQTtJQUM5RCxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLHdCQUF3QixDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsQ0FBQTtRQUN0RCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pCLENBQUM7SUFFRCxJQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFBO0lBRXZELElBQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUNwRCxJQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQTtJQUN0RSxJQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFB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QUFDLDhCQUF5QixhQUFlLENBQUMsQ0FBQTtRQUNwRSxDQUFDO0lBQ0gsQ0FBQztJQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDWCxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2hCLE1BQU0sQ0FBQyxDQUFBO0lBQ1QsQ0FBQztZQUFTLENBQUM7UUFDVCxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUE7SUFDMUIsQ0FBQztBQUNILENBQUM7QUExSUQsNEJBMElDO0FBRUQsa0NBQ0UsV0FBbUIsRUFDbkIsZUFBdUI7SUFFdkIsT0FBTyxDQUFDLEtBQUssQ0FDWCxxQkFBbUIsV0FBVyw4QkFFZCxlQUFpQixDQUNsQyxDQUFBO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdyZWVuIH0gZnJvbSBcImNoYWxrXCJcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCJcbmltcG9ydCAqIGFzIHJpbXJhZiBmcm9tIFwicmltcmFmXCJcbmltcG9ydCAqIGFzIHRtcCBmcm9tIFwidG1wXCJcbmltcG9ydCB7XG4gIHJlc29sdmVSZWxhdGl2ZUZpbGVEZXBlbmRlbmNpZXNJblBhY2thZ2VKc29uLFxuICByZXNvbHZlUmVsYXRpdmVGaWxlRGVwZW5kZW5jaWVzSW5QYWNrYWdlTG9jayxcbn0gZnJvbSBcIi4vcmVzb2x2ZVJlbGF0aXZlRmlsZURlcGVuZGVuY2llc1wiXG5pbXBvcnQgc3Bhd25TYWZlU3luYyBmcm9tIFwiLi9zcGF3blNhZmVcIlxuaW1wb3J0IHsgZ2V0UGF0Y2hGaWxlcyB9IGZyb20gXCIuL3BhdGNoRnNcIlxuaW1wb3J0ICogYXMgZnNFeHRyYSBmcm9tIFwiZnMtZXh0cmFcIlxuaW1wb3J0IHsgUGFja2FnZU1hbmFnZXIgfSBmcm9tIFwiLi9kZXRlY3RQYWNrYWdlTWFuYWdlclwiXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIG1ha2VQYXRjaChcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcbiAgYXBwUGF0aDogc3RyaW5nLFxuICBwYWNrYWdlTWFuYWdlcjogUGFja2FnZU1hbmFnZXIsXG4pIHtcbiAgY29uc3Qgbm9kZU1vZHVsZXNQYXRoID0gcGF0aC5qb2luKGFwcFBhdGgsIFwibm9kZV9tb2R1bGVzXCIpXG4gIGNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5qb2luKG5vZGVNb2R1bGVzUGF0aCwgcGFja2FnZU5hbWUpXG4gIGNvbnN0IHBhY2thZ2VKc29uUGF0aCA9IHBhdGguam9pbihwYWNrYWdlUGF0aCwgXCJwYWNrYWdlLmpzb25cIilcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHBhY2thZ2VKc29uUGF0aCkpIHtcbiAgICBwcmludE5vUGFja2FnZUZvdW5kRXJyb3IocGFja2FnZU5hbWUsIHBhY2thZ2VKc29uUGF0aClcbiAgICBwcm9jZXNzLmV4aXQoMSlcbiAgfVxuXG4gIGNvbnN0IHBhY2thZ2VWZXJzaW9uID0gcmVxdWlyZShwYWNrYWdlSnNvblBhdGgpLnZlcnNpb25cblxuICBjb25zdCB0bXBSZXBvID0gdG1wLmRpclN5bmMoeyB1bnNhZmVDbGVhbnVwOiB0cnVlIH0pXG4gIGNvbnN0IHRtcFJlcG9Ob2RlTW9kdWxlc1BhdGggPSBwYXRoLmpvaW4odG1wUmVwby5uYW1lLCBcIm5vZGVfbW9kdWxlc1wiKVxuICBjb25zdCB0bXBSZXBvUGFja2FnZUpzb25QYXRoID0gcGF0aC5qb2luKHRtcFJlcG8ubmFtZSwgXCJwYWNrYWdlLmpzb25cIilcbiAgY29uc3QgdG1wUmVwb1BhY2thZ2VQYXRoID0gcGF0aC5qb2luKHRtcFJlcG9Ob2RlTW9kdWxlc1BhdGgsIHBhY2thZ2VOYW1lKVxuXG4gIHRyeSB7XG4gICAgY29uc3QgcGF0Y2hlc0RpciA9IHBhdGguam9pbihhcHBQYXRoLCBcInBhdGNoZXNcIilcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhwYXRjaGVzRGlyKSkge1xuICAgICAgZnMubWtkaXJTeW5jKHBhdGNoZXNEaXIpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHJlbW92ZSBleHNpdGluZyBwYXRjaCBmb3IgdGhpcyBwYWNrYWdlLCBpZiBhbnlcbiAgICAgIGdldFBhdGNoRmlsZXMocGF0Y2hlc0RpcikuZm9yRWFjaChmaWxlTmFtZSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBmaWxlTmFtZS5zdGFydHNXaXRoKHBhY2thZ2VOYW1lICsgXCI6XCIpIHx8XG4gICAgICAgICAgZmlsZU5hbWUuc3RhcnRzV2l0aChwYWNrYWdlTmFtZSArIFwiK1wiKVxuICAgICAgICApIHtcbiAgICAgICAgICBjb25zb2xlLmluZm8oXG4gICAgICAgICAgICBncmVlbihcIuKYkVwiKSxcbiAgICAgICAgICAgIFwiUmVtb3ZpbmcgZXhpc3RpbmdcIixcbiAgICAgICAgICAgIHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgcGF0aC5qb2luKHBhdGNoZXNEaXIsIGZpbGVOYW1lKSksXG4gICAgICAgICAgKVxuICAgICAgICAgIGZzLnVubGlua1N5bmMocGF0aC5qb2luKHBhdGNoZXNEaXIsIGZpbGVOYW1lKSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zb2xlLmluZm8oZ3JlZW4oXCLimJFcIiksIFwiQ3JlYXRpbmcgdGVtcG9yYXJ5IGZvbGRlclwiKVxuXG4gICAgY29uc3QgdG1wRXhlYyA9IChjb21tYW5kOiBzdHJpbmcsIGFyZ3M/OiBzdHJpbmdbXSkgPT5cbiAgICAgIHNwYXduU2FmZVN5bmMoY29tbWFuZCwgYXJncywgeyBjd2Q6IHRtcFJlcG8ubmFtZSB9KVxuICAgIC8vIHJlaW5zdGFsbCBhIGNsZWFuIHZlcnNpb24gb2YgdGhlIHVzZXIncyBub2RlX21vZHVsZXMgaW4gb3VyIHRtcCBsb2NhdGlvblxuICAgIGZzRXh0cmEuY29weVN5bmMoXG4gICAgICBwYXRoLmpvaW4oYXBwUGF0aCwgXCJwYWNrYWdlLmpzb25cIiksXG4gICAgICBwYXRoLmpvaW4odG1wUmVwby5uYW1lLCBcInBhY2thZ2UuanNvblwiKSxcbiAgICApXG4gICAgLy8gcmVzb2x2ZSByZWxhdGl2ZSBmaWxlIHBhdGhzIGluIHBhY2thZ2UuanNvblxuICAgIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgICB0bXBSZXBvUGFja2FnZUpzb25QYXRoLFxuICAgICAgSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHJlc29sdmVSZWxhdGl2ZUZpbGVEZXBlbmRlbmNpZXNJblBhY2thZ2VKc29uKFxuICAgICAgICAgIGFwcFBhdGgsXG4gICAgICAgICAgcmVxdWlyZSh0bXBSZXBvUGFja2FnZUpzb25QYXRoKSxcbiAgICAgICAgKSxcbiAgICAgICksXG4gICAgKVxuXG4gICAgaWYgKHBhY2thZ2VNYW5hZ2VyID09PSBcInlhcm5cIikge1xuICAgICAgZnNFeHRyYS5jb3B5U3luYyhcbiAgICAgICAgcGF0aC5qb2luKGFwcFBhdGgsIFwieWFybi5sb2NrXCIpLFxuICAgICAgICBwYXRoLmpvaW4odG1wUmVwby5uYW1lLCBcInlhcm4ubG9ja1wiKSxcbiAgICAgIClcbiAgICAgIGNvbnNvbGUuaW5mbyhncmVlbihcIuKYkVwiKSwgXCJCdWlsZGluZyBjbGVhbiBub2RlX21vZHVsZXMgd2l0aCB5YXJuXCIpXG4gICAgICB0bXBFeGVjKGB5YXJuYClcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbG9ja0ZpbGVOYW1lID1cbiAgICAgICAgcGFja2FnZU1hbmFnZXIgPT09IFwibnBtLXNocmlua3dyYXBcIlxuICAgICAgICAgID8gXCJucG0tc2hyaW5rd3JhcC5qc29uXCJcbiAgICAgICAgICA6IFwicGFja2FnZS1sb2NrLmpzb25cIlxuXG4gICAgICBjb25zdCBsb2NrRmlsZUNvbnRlbnRzID0gSlNPTi5wYXJzZShcbiAgICAgICAgZnNFeHRyYS5yZWFkRmlsZVN5bmMocGF0aC5qb2luKGFwcFBhdGgsIGxvY2tGaWxlTmFtZSkpLnRvU3RyaW5nKCksXG4gICAgICApXG4gICAgICBjb25zdCByZXNvbHZlZExvY2tGaWxlQ29udGVudHMgPSByZXNvbHZlUmVsYXRpdmVGaWxlRGVwZW5kZW5jaWVzSW5QYWNrYWdlTG9jayhcbiAgICAgICAgYXBwUGF0aCxcbiAgICAgICAgbG9ja0ZpbGVDb250ZW50cyxcbiAgICAgIClcbiAgICAgIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgICAgIHBhdGguam9pbih0bXBSZXBvLm5hbWUsIGxvY2tGaWxlTmFtZSksXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHJlc29sdmVkTG9ja0ZpbGVDb250ZW50cyksXG4gICAgICApXG4gICAgICBjb25zb2xlLmluZm8oZ3JlZW4oXCLimJFcIiksIFwiQnVpbGRpbmcgY2xlYW4gbm9kZV9tb2R1bGVzIHdpdGggbnBtXCIpXG4gICAgICB0bXBFeGVjKFwibnBtXCIsIFtcImlcIl0pXG4gICAgfVxuXG4gICAgLy8gY29tbWl0IHRoZSBwYWNrYWdlXG4gICAgY29uc29sZS5pbmZvKGdyZWVuKFwi4piRXCIpLCBcIkRpZmZpbmcgeW91ciBmaWxlcyB3aXRoIGNsZWFuIGZpbGVzXCIpXG4gICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgIHBhdGguam9pbih0bXBSZXBvLm5hbWUsIFwiLmdpdGlnbm9yZVwiKSxcbiAgICAgIFwiIS9ub2RlX21vZHVsZXNcXG5cXG5cIixcbiAgICApXG4gICAgdG1wRXhlYyhcImdpdFwiLCBbXCJpbml0XCJdKVxuICAgIGNvbnN0IHN0YWdlRmlsZXMgPSAoKSA9PiB7XG4gICAgICB0bXBFeGVjKFwiZ2l0XCIsIFtcImFkZFwiLCBcIi1mXCIsIHBhdGguam9pbihcIm5vZGVfbW9kdWxlc1wiLCBwYWNrYWdlTmFtZSldKVxuICAgICAgdG1wRXhlYyhcImdpdFwiLCBbXG4gICAgICAgIFwicm1cIixcbiAgICAgICAgXCItLWNhY2hlZFwiLFxuICAgICAgICBwYXRoLmpvaW4oXCJub2RlX21vZHVsZXNcIiwgcGFja2FnZU5hbWUsIFwicGFja2FnZS5qc29uXCIpLFxuICAgICAgXSlcbiAgICB9XG4gICAgc3RhZ2VGaWxlcygpXG4gICAgdG1wRXhlYyhcImdpdFwiLCBbXCJjb21taXRcIiwgXCItbVwiLCBcImluaXRcIl0pXG5cbiAgICAvLyByZXBsYWNlIHBhY2thZ2Ugd2l0aCB1c2VyJ3MgdmVyc2lvblxuICAgIHJpbXJhZi5zeW5jKHRtcFJlcG9QYWNrYWdlUGF0aClcbiAgICBmc0V4dHJhLmNvcHlTeW5jKHBhY2thZ2VQYXRoLCB0bXBSZXBvUGFja2FnZVBhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pXG5cbiAgICAvLyBhZGQgdGhlaXIgZmlsZXMgdG8gdGhlIGluZGV4XG4gICAgc3RhZ2VGaWxlcygpXG5cbiAgICAvLyBnZXQgZGlmZiBvZiBjaGFuZ2VzXG4gICAgY29uc3QgcGF0Y2ggPSB0bXBFeGVjKFwiZ2l0XCIsIFtcImRpZmZcIiwgXCJIRUFEXCJdKS5zdGRvdXQudG9TdHJpbmcoKVxuXG4gICAgaWYgKHBhdGNoLnRyaW0oKSA9PT0gXCJcIikge1xuICAgICAgY29uc29sZS53YXJuKGDigYnvuI8gIE5vdCBjcmVhdGluZyBwYXRjaCBmaWxlIGZvciBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSdgKVxuICAgICAgY29uc29sZS53YXJuKGDigYnvuI8gIFRoZXJlIGRvbid0IGFwcGVhciB0byBiZSBhbnkgY2hhbmdlcy5gKVxuICAgICAgcHJvY2Vzcy5leGl0KDEpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHBhdGNoRmlsZU5hbWUgPSBgJHtwYWNrYWdlTmFtZX0rJHtwYWNrYWdlVmVyc2lvbn0ucGF0Y2hgXG4gICAgICBjb25zdCBwYXRjaFBhdGggPSBwYXRoLmpvaW4ocGF0Y2hlc0RpciwgcGF0Y2hGaWxlTmFtZSlcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhwYXRoLmRpcm5hbWUocGF0Y2hQYXRoKSkpIHtcbiAgICAgICAgLy8gc2NvcGVkIHBhY2thZ2VcbiAgICAgICAgZnMubWtkaXJTeW5jKHBhdGguZGlybmFtZShwYXRjaFBhdGgpKVxuICAgICAgfVxuICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRjaFBhdGgsIHBhdGNoKVxuICAgICAgY29uc29sZS5sb2coYCR7Z3JlZW4oXCLinJRcIil9IENyZWF0ZWQgZmlsZSBwYXRjaGVzLyR7cGF0Y2hGaWxlTmFtZX1gKVxuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoZSlcbiAgICB0aHJvdyBlXG4gIH0gZmluYWxseSB7XG4gICAgdG1wUmVwby5yZW1vdmVDYWxsYmFjaygpXG4gIH1cbn1cblxuZnVuY3Rpb24gcHJpbnROb1BhY2thZ2VGb3VuZEVycm9yKFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuICBwYWNrYWdlSnNvblBhdGg6IHN0cmluZyxcbikge1xuICBjb25zb2xlLmVycm9yKFxuICAgIGBObyBzdWNoIHBhY2thZ2UgJHtwYWNrYWdlTmFtZX1cblxuICBGaWxlIG5vdCBmb3VuZDogJHtwYWNrYWdlSnNvblBhdGh9YCxcbiAgKVxufVxuIl19